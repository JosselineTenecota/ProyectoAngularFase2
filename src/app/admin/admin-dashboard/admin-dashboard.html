<div class="admin-wrapper wrapper">
  <div class="admin-header-flex">
    <div class="header-text">
      <h1>GestiÃ³n de Usuarios</h1>
      <p>Servidor: <strong>WildFly / PostgreSQL</strong></p>
    </div>
    <button class="btn-create" (click)="toggleCreateModal()">+ Nuevo Usuario</button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>CÃ©dula</th>
          <th>Perfil / Correo</th>
          <th>WhatsApp</th> <th>Rol</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users$ | async">
          
          <ng-container *ngIf="editingId !== user.correo">
            <td>{{ user.persona?.cedula || '---' }}</td>
            <td>
              <div class="user-info">
                <img [src]="'https://ui-avatars.com/api/?name=' + (user.persona?.nombre || 'U')" class="avatar">
                <div>
                  <div class="name">{{ user.persona?.nombre || 'Sin Nombre' }}</div>
                  <div class="email">{{ user.correo }}</div>
                </div>
              </div>
            </td>
            <td>{{ user.persona?.telefono || '---' }}</td> <td>
              <span class="role-badge" [ngClass]="user.rol?.toLowerCase()">
                {{ user.rol }}
              </span>
            </td>
            <td>
              <button class="btn-icon edit" (click)="startEdit(user)">âœŽ</button>
              <button class="btn-icon delete" (click)="deleteUser(user.correo)">ðŸ—‘</button>
            </td>
          </ng-container>

          <ng-container *ngIf="editingId === user.correo">
            <td>
              <input type="text" [value]="user.persona?.cedula" class="input-dark" disabled>
            </td>
            <td>
              <div class="edit-cell">
                <input type="text" [(ngModel)]="editForm.tempNombre" class="input-dark" placeholder="Nombre completo">
                <div class="email-sub">{{ user.correo }}</div>
              </div>
            </td>
            <td>
              <input type="text" [(ngModel)]="editForm.tempTelefono" class="input-dark" placeholder="WhatsApp">
            </td>
            <td>
              <select [(ngModel)]="editForm.rol" class="input-dark">
                <option value="CLIENTE">CLIENTE</option>
                <option value="PROGRAMADOR">PROGRAMADOR</option>
                <option value="ADMIN">ADMIN</option>
              </select>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-save" (click)="saveUser()">Guardar</button>
                <button class="btn-cancel" (click)="cancelEdit()">X</button>
              </div>
            </td>
          </ng-container>

        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="modal-overlay" *ngIf="showCreateModal">
  <div class="modal-content">
    <h2>Registrar Nuevo Usuario</h2>
    <div class="form-group">
      <label>CÃ©dula</label>
      <input type="text" [(ngModel)]="newUser.cedula" class="input-dark">
    </div>
    <div class="form-group">
      <label>Nombre</label>
      <input type="text" [(ngModel)]="newUser.nombre" class="input-dark">
    </div>
    <div class="form-group">
      <label>WhatsApp</label>
      <input type="text" [(ngModel)]="newUser.telefono" class="input-dark" placeholder="Ej: 0987654321">
    </div>
    <div class="form-group">
      <label>Correo</label>
      <input type="email" [(ngModel)]="newUser.correo" class="input-dark">
    </div>
    <div class="form-group">
      <label>Rol</label>
      <select [(ngModel)]="newUser.rol" class="input-dark">
        <option value="CLIENTE">Cliente</option>
        <option value="PROGRAMADOR">Programador</option>
        <option value="ADMIN">Admin</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="toggleCreateModal()">Cancelar</button>
      <button class="btn-save" (click)="createUser()">Registrar en DB</button>
    </div>
  </div>
</div>